<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPress 設定情報抽出ツール v1.1.0</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React CDN -->
    <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Babel CDN (for JSX) -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js"></script>
    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif; /* Default browser font, React app will manage its own */
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root" class="container mx-auto p-4"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { jsPDF } = window.jspdf;

        const App = () => {
            const [wpUrl, setWpUrl] = useState('');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const [currentView, setCurrentView] = useState('login'); // 'login', 'loading', 'results'
            const [extractedData, setExtractedData] = useState(null);
            const [progress, setProgress] = useState(0);
            const [showHelpModal, setShowHelpModal] = useState(false);

            const fetchWordPressData = async (endpoint, options = {}) => {
                const headers = new Headers();
                headers.append('Authorization', 'Basic ' + btoa(username + ':' + password));
                
                // Ensure wpUrl doesn't end with a slash before appending endpoint
                const normalizedWpUrl = wpUrl.endsWith('/') ? wpUrl.slice(0, -1) : wpUrl;
                const fullUrl = `${normalizedWpUrl}${endpoint}`;

                try {
                    const response = await fetch(fullUrl, { ...options, headers });
                    if (!response.ok) {
                        let errorData;
                        let errorMessage = `サーバーエラー (${response.status}): ${response.statusText}`; // Default message
                        try {
                            errorData = await response.json();
                            if (errorData && errorData.message) {
                                errorMessage = errorData.message; // Prefer message from WordPress
                            }
                        } catch (e) { /* ignore if error response is not json */ }

                        if (response.status === 401 || response.status === 403) {
                            let detailedErrorMessage = errorMessage;
                            if (response.status === 401) {
                                detailedErrorMessage = `ログインに失敗しました。ユーザーID、パスワード、またはアプリケーションパスワードが正しいか確認してください。WordPressサイトでREST APIのBasic認証またはアプリケーションパスワードが有効になっている必要もあります。 (詳細: ${errorData.message || response.statusText || 'エラー情報なし'}${errorData.code ? ` [コード: ${errorData.code}]` : ''})`;
                            } else { // 403
                                detailedErrorMessage = `要求された操作を実行する権限がありません。このユーザーアカウントに必要な権限 (通常は管理者権限) が付与されているか確認してください。 (詳細: ${errorData.message || response.statusText || 'エラー情報なし'}${errorData.code ? ` [コード: ${errorData.code}]` : ''})`;
                            }
                            throw new Error(detailedErrorMessage);
                        }
                        if (response.status === 404) {
                            // Check if it's a general API 404 or endpoint specific
                             try {
                                const baseApiResponse = await fetch(`${normalizedWpUrl}/wp-json/`, { headers });
                                if (!baseApiResponse.ok) {
                                     throw new Error(`WordPressのREST APIエンドポイント (${normalizedWpUrl}/wp-json/) にアクセスできませんでした (404 Not Found)。URLが正しいか、WordPressサイトでREST APIが有効になっているか、パーマリンク設定が「デフォルト」以外に設定されているかを確認してください。`);
                                }
                                // If base API is fine, then it's the specific endpoint that's 404
                                throw new Error(`指定されたエンドポイント (${endpoint}) が見つかりません (404)。WordPressのバージョンや設定を確認してください。`); 
                            } catch (e) {
                                if (e.message && e.message.includes('指定されたエンドポイント')) { // Check if it's the specific endpoint 404
                                    throw new Error(e.message + ` このエンドポイントは、特定のプラグインやWordPressのバージョンに依存する場合があります。`);
                                }
                                throw new Error(e.message || `REST API (${normalizedWpUrl}/wp-json/) が見つからないか、アクセスできません。URL、パーマリンク設定、またはREST APIの有効状態を確認してください。`);
                            }
                        }
                        // For other errors, use the errorMessage (either from WP or the default server error)
                        throw new Error(errorMessage);
                    }
                    return await response.json();
                } catch (err) {
                    console.error('Fetch error:', err);
                    if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
                        throw new Error(`ネットワークエラー: 指定されたURL (${fullUrl}) に接続できませんでした。URLが正しいか、インターネット接続が利用可能か、ファイアウォールやCORSポリシーによってアクセスがブロックされていないか確認してください。詳細: ${err.message}`);
                    }
                    throw err; // Re-throw other errors to be caught by handleLogin or specific catch blocks
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setIsLoading(true);
                setCurrentView('loading');
                setProgress(0);

                if (!wpUrl || !username || !password) {
                    setError('WordPress サイト URL、ユーザー ID、パスワードをすべて入力してください。');
                    setIsLoading(false);
                    setCurrentView('login');
                    return;
                }

                console.log('Attempting to fetch WordPress data from:', wpUrl);
                const allExtractedData = {};
                let siteTitle = 'タイトル不明';

                try {
                    setProgress(5); // Starting
                    console.log('Fetching Site Settings (/wp-json/wp/v2/settings)...');
                    const settings = await fetchWordPressData('/wp-json/wp/v2/settings');
                    siteTitle = settings.title || 'タイトル不明';
                    allExtractedData.general = {
                        'サイトのタイトル': settings.title,
                        'キャッチフレーズ': settings.description,
                        'WordPress アドレス (URL)': settings.url, // This is site URL, not WP install URL
                        'サイトアドレス (URL)': settings.home, // This is home URL
                        '管理者メールアドレス': settings.email,
                        'メンバーシップ': settings.users_can_register ? '誰でもユーザー登録ができるようにする' : '登録不可',
                        '新規ユーザーのデフォルト権限グループ': settings.default_role,
                        'サイトの言語': settings.language,
                        'タイムゾーン': settings.timezone_string,
                        '日付フォーマット': settings.date_format,
                        '時刻フォーマット': settings.time_format,
                        '週の始まり': settings.start_of_week,
                    };
                    allExtractedData.display = {
                        'ホームページの表示': settings.show_on_front === 'page' ? '固定ページ' : '最新の投稿',
                        'ホームページ': settings.page_on_front ? `ID: ${settings.page_on_front}` : 'N/A',
                        '投稿ページ': settings.page_for_posts ? `ID: ${settings.page_for_posts}` : 'N/A',
                        '1ページに表示する最大投稿数': settings.posts_per_page,
                        'フィード内の各投稿に含める内容': settings.posts_per_rss === 'full' ? '全文を表示' : '抜粋のみを表示',
                        '検索エンジンでの表示': settings.blog_public ? '検索エンジンがサイトをインデックスしないようにする' : 'インデックス許可',
                    };
                    setProgress(30);

                    try {
                        console.log('Fetching Active Plugins (/wp-json/wp/v2/plugins?status=active)...');
                        const activePlugins = await fetchWordPressData('/wp-json/wp/v2/plugins?status=active');
                        allExtractedData.plugins = activePlugins.map(plugin => ({
                            name: plugin.name,
                            version: plugin.version,
                            author: plugin.author_uri ? `<a href="${plugin.author_uri}" target="_blank">${plugin.author}</a>` : plugin.author,
                            description: plugin.description.rendered || plugin.description
                        }));
                    } catch (pluginError) {
                        console.warn('Could not fetch plugin list:', pluginError.message);
                        allExtractedData.plugins = { error: 'プラグイン情報の取得に失敗しました。', details: pluginError.message };
                    }
                    setProgress(60);

                    try {
                        console.log('Fetching Active Theme (/wp-json/wp/v2/themes?status=active)...');
                        const activeThemes = await fetchWordPressData('/wp-json/wp/v2/themes?status=active');
                        if (activeThemes && activeThemes.length > 0) {
                            const theme = activeThemes[0]; // Typically only one active theme
                            allExtractedData.theme = {
                                name: theme.name.rendered || theme.name,
                                version: theme.version,
                                author: theme.author.rendered ? `<a href="${theme.author_uri.rendered}" target="_blank">${theme.author.rendered}</a>` : theme.author.rendered,
                                description: theme.description.rendered || theme.description,
                            };
                        } else {
                            allExtractedData.theme = { error: '有効なテーマが見つかりませんでした。', details: 'APIからの応答が空でした。' };
                        }
                    } catch (themeError) {
                        console.warn('Could not fetch theme information:', themeError.message);
                        allExtractedData.theme = { error: 'テーマ情報の取得に失敗しました。', details: themeError.message };
                    }
                    // Discussion, Media, and Permalink settings are also in the 'settings' object fetched earlier
                    allExtractedData.discussion = {
                        '新しい投稿へのコメントを許可する': settings.default_comment_status === 'open' ? 'はい' : 'いいえ',
                        'コメント投稿者の名前とメールアドレスの入力を必須にする': settings.require_name_email ? 'はい' : 'いいえ',
                        'ユーザー登録してログインしたユーザーのみコメントをつけられるようにする': settings.comment_registration ? 'はい' : 'いいえ',
                        // 'コメントの手動承認を必須とする': settings.comment_moderation ? 'はい' : 'いいえ', // This is often true by default
                        'すでに承認されたコメントの投稿者のコメントを許可し、それ以外のコメントを承認待ちにする': settings.comment_whitelist ? 'はい' : 'いいえ',
                        'コメント内で許可されないキーワード数': settings.comment_max_links, // Number of links that causes comment to be held for moderation
                        'モデレーションを行うキーワード': settings.moderation_keys ? settings.moderation_keys.replace(/\n/g, ', ') : 'なし',
                        '許可しないキーワード': settings.disallowed_keys ? settings.disallowed_keys.replace(/\n/g, ', ') : 'なし',
                        '自分宛のメール通知 (コメントが投稿されたとき)': settings.comments_notify ? 'はい' : 'いいえ',
                        '自分宛のメール通知 (コメントが承認待ちになったとき)': settings.moderation_notify ? 'はい' : 'いいえ',
                        'アバターの表示': settings.show_avatars ? 'アバターを表示する' : '表示しない',
                        '評価': settings.avatar_rating ? `「${settings.avatar_rating.toUpperCase()}」評価が適切` : 'N/A',
                        'デフォルトのアバター': settings.avatar_default || 'ミステリーパーソン',
                    };

                    allExtractedData.media = {
                        'サムネイルのサイズ': `幅 ${settings.thumbnail_size_w} x 高さ ${settings.thumbnail_size_h}` + (settings.thumbnail_crop ? ' (サムネイルを実寸法にトリミングする)' : ''),
                        '中サイズ': `最大幅 ${settings.medium_size_w}, 最大高さ ${settings.medium_size_h}`,
                        '大サイズ': `最大幅 ${settings.large_size_w}, 最大高さ ${settings.large_size_h}`,
                        'アップロードしたファイルを年月ベースのフォルダーに整理': settings.uploads_use_yearmonth_folders ? 'はい' : 'いいえ',
                    };

                    allExtractedData.permalinks = {
                        'パーマリンク構造': settings.permalink_structure || 'デフォルト',
                        'カテゴリーベース': settings.category_base || 'なし',
                        'タグベース': settings.tag_base || 'なし',
                    };
                    setProgress(85);

                    console.log('Fetching Users (/wp-json/wp/v2/users?per_page=100)...');
                    // Attempt to get users. This might require 'list_users' capability.
                    // For simplicity, fetching first 100 users. Real app might need pagination handling.
                    try {
                        const users = await fetchWordPressData('/wp-json/wp/v2/users?per_page=100&context=view'); // context=edit often needed for roles
                        allExtractedData.users = users.map(user => ({
                            name: user.name,
                            slug: user.slug,
                            roles: user.roles ? user.roles.join(', ') : 'N/A (ロール情報取得不可)',
                            // link: user.link // Link to author archive
                        }));
                    } catch (userError) {
                        console.warn('Could not fetch user list:', userError.message);
                        allExtractedData.users = { error: 'ユーザーリストの取得に失敗しました。権限が不足している可能性があります。', details: userError.message };
                    }
                    setProgress(95);

                    // Widgets and Menus are more complex and often not fully exposed via core REST API without specific plugins or themes.
                    // For now, we'll skip them as per the spec's note "REST API で取得可能な範囲"
                    allExtractedData.widgets = { status: 'ウィジェット情報の取得は現在サポートされていません。' };
                    allExtractedData.menus = { status: 'メニュー情報の取得は現在サポートされていません。' };

                    console.log('All data fetched:', allExtractedData);
                    setProgress(100);

                    const summaryDetails = {};
                    let totalItemsFetched = 0;
                    for (const key in allExtractedData) {
                        const data = allExtractedData[key];
                        if (data && data.error) {
                            summaryDetails[key] = 'エラー';
                        } else if (Array.isArray(data)) {
                            summaryDetails[key] = `${data.length} 件`;
                            totalItemsFetched += data.length;
                        } else if (typeof data === 'object' && data !== null && data.status) {
                             summaryDetails[key] = '未サポート'; // For widgets/menus status
                        } else if (typeof data === 'object' && data !== null) {
                            const itemCount = Object.keys(data).length;
                            summaryDetails[key] = `${itemCount} 項目`;
                            totalItemsFetched += itemCount;
                        } else {
                            summaryDetails[key] = '不明';
                        }
                    }

                    setExtractedData({
                        siteTitle: siteTitle,
                        generationDate: new Date().toLocaleString('ja-JP'),
                        details: allExtractedData,
                        summary: {
                            categories: Object.keys(allExtractedData).length,
                            itemsPerCategory: summaryDetails, // Add this line
                            totalItems: totalItemsFetched // Add this line
                        }
                    });
                    setCurrentView('results');
                } catch (err) {
                    console.error('Login or data fetching failed:', err);
                    setError(`エラーが発生しました: ${err.message}`);
                    setCurrentView('login');
                } finally {
                    setIsLoading(false);
                }
            }; // This closes const handleLogin

        const resetApp = () => {
            setWpUrl('');
            setUsername('');
            setPassword('');
            setIsLoading(false);
            setError('');
            setCurrentView('login');
            setExtractedData(null);
            setProgress(0);
        };
        

            
            const handleCancel = () => {
                // In a real scenario, you might need to abort API requests
                console.log('Operation cancelled by user.');
                resetApp();
            };

            const handleGenerateHtml = async () => {
                if (!extractedData || !extractedData.details) {
                    alert('HTMLを生成するためのデータがありません。');
                    return;
                }
                console.log('Generating HTML...');
                setIsLoading(true);
                setProgress(0); // Reset progress for HTML generation

                // HTML generation logic will go here
                const siteTitle = extractedData.siteTitle || 'WordPress 設定レポート';
                const generationDate = extractedData.generationDate;
                let htmlContent = `<!DOCTYPE html>\n<html lang="ja">\n<head>\n  <meta charset="UTF-8">\n  <title>WordPress設定レポート - ${siteTitle}</title>\n  <style>\n    body { font-family: sans-serif; margin: 20px; line-height: 1.6; }\n    h1, h2, h3 { color: #333; }\n    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }\n    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }\n    th { background-color: #f2f2f2; }\n    .category { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }\n    .category:last-child { border-bottom: none; }\n    .error { color: red; font-weight: bold; }\n    .error-details { font-size: 0.9em; color: #777; }\n    ul, ol { padding-left: 20px; }\n  </style>\n</head>\n<body>\n`;

                htmlContent += `  <h1>WordPress設定レポート: ${siteTitle}</h1>\n`;
                htmlContent += `  <p>生成日時: ${generationDate}</p>\n`;
                
                // Table of Contents (Placeholder for now, can be dynamic later)
                htmlContent += `  <h2>目次</h2>\n  <ul>\n`;
                const categoryTitles = {
                    general: '一般設定',
                    display: '表示設定',
                    discussion: 'ディスカッション設定',
                    media: 'メディア設定',
                    permalinks: 'パーマリンク設定',
                    plugins: '有効化されているプラグイン一覧',
                    theme: '使用中のテーマ',
                    users: '登録ユーザー一覧と役割',
                    widgets: 'ウィジェット設定',
                    menus: 'メニュー設定'
                };
                for (const categoryKey in extractedData.details) {
                    htmlContent += `    <li><a href="#${categoryKey}">${categoryTitles[categoryKey] || categoryKey}</a></li>\n`;
                }
                htmlContent += `  </ul>\n`;
                setProgress(15);

                // Content Sections
                let currentHtmlProgress = 15;
                const totalCategories = Object.keys(extractedData.details).length;
                const progressPerCategory = totalCategories > 0 ? Math.floor((90 - 15) / totalCategories) : 0;

                for (const categoryKey in extractedData.details) {
                    const categoryData = extractedData.details[categoryKey];
                    const categoryTitle = categoryTitles[categoryKey] || categoryKey;
                    htmlContent += `  <div class="category" id="${categoryKey}">\n`;
                    htmlContent += `    <h2>${categoryTitle}</h2>\n`;

                    if (categoryData && typeof categoryData === 'object' && categoryData.error) {
                        htmlContent += `    <p class="error">エラー: ${categoryData.error}</p>\n`;
                        if (categoryData.details) {
                            htmlContent += `    <p class="error-details">詳細: ${categoryData.details}</p>\n`;
                        }
                    } else if (Array.isArray(categoryData)) {
                        htmlContent += '    <ul>\n';
                        categoryData.forEach(item => {
                            htmlContent += '      <li>';
                            if (categoryKey === 'plugins') {
                                htmlContent += `<strong>プラグイン名:</strong> ${item.name || 'N/A'} (v${item.version || 'N/A'})`;
                                if(item.description) htmlContent += `<br><em>説明:</em> ${item.description.replace(/<[^>]+>/g, '')}`;
                                if(item.author) htmlContent += `<br><em>作者:</em> ${item.author.replace(/<[^>]+>/g, '')}`;
                            } else if (categoryKey === 'users') {
                                htmlContent += `<strong>ユーザー名:</strong> ${item.name || 'N/A'} (Slug: ${item.slug || 'N/A'})`;
                                htmlContent += `<br><em>役割:</em> ${item.roles || 'N/A'}`;
                            } else {
                                htmlContent += JSON.stringify(item); // Fallback for other arrays
                            }
                            htmlContent += '</li>\n';
                        });
                        htmlContent += '    </ul>\n';
                    } else if (typeof categoryData === 'object' && categoryData !== null) {
                        if (categoryData.status && Object.keys(categoryData).length === 1) {
                             htmlContent += `    <p>${categoryData.status}</p>\n`;
                        } else {
                            htmlContent += '    <table>\n';
                            for (const key in categoryData) {
                                const value = categoryData[key] !== null && categoryData[key] !== undefined ? String(categoryData[key]) : 'N/A';
                                htmlContent += `      <tr><th>${key}</th><td>${value}</td></tr>\n`;
                            }
                            htmlContent += '    </table>\n';
                        }
                    } else {
                        htmlContent += `    <p>${String(categoryData)}</p>\n`; // Fallback for simple values
                    }
                    htmlContent += `  </div>\n`;
                    currentHtmlProgress = Math.min(currentHtmlProgress + progressPerCategory, 90);
                    setProgress(currentHtmlProgress);
                }

                htmlContent += `</body>\n</html>`;

                // Create a Blob and trigger download
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                const safeSiteTitleForFile = (extractedData.siteTitle || 'WordPressReport').replace(/[^a-z0-9_\-]+/gi, '_');
                const dateStrForFile = new Date().toISOString().slice(0,10).replace(/-/g,'');
                link.download = `${safeSiteTitleForFile}_${dateStrForFile}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                setProgress(100);
                console.log('HTML Generated and download initiated.');
                setIsLoading(false);
            };








            const categoryTitles = {
                general: '一般設定',
                display: '表示設定',
                discussion: 'ディスカッション設定',
                media: 'メディア設定',
                permalinks: 'パーマリンク設定',
                plugins: '有効化されているプラグイン一覧',
                theme: '使用中のテーマ',
                users: '登録ユーザー一覧と役割',
                widgets: 'ウィジェット設定',
                menus: 'メニュー設定'
            };

            const renderDetailSection = (categoryKey, categoryData) => {
                // categoryTitles is in scope
                if (categoryData && typeof categoryData === 'object' && categoryData.error) {
                    return (
                        <div>
                            <p className="text-red-600 font-semibold">エラー: {categoryData.error}</p>
                            {categoryData.details && <p className="text-sm text-gray-500">詳細: {categoryData.details}</p>}
                        </div>
                    );
                }
                if (Array.isArray(categoryData)) {
                    return (
                        <ul className="list-disc pl-5 space-y-1">
                            {categoryData.map((item, index) => (
                                <li key={index} className="mb-1 p-2 bg-gray-50 rounded text-sm">
                                    {categoryKey === 'plugins' ? (
                                        <div>
                                            <strong>{item.name || 'N/A'}</strong> (v{item.version || 'N/A'})<br />
                                            {item.author && <span className="text-xs italic">作者: {item.author.replace(/<[^>]+>/g, '')}</span>}<br/>
                                            {item.description && <p className="text-xs mt-1">説明: {item.description.replace(/<[^>]+>/g, '')}</p>}
                                        </div>
                                    ) : categoryKey === 'users' ? (
                                        <span><strong>{item.name || 'N/A'}</strong> (Slug: {item.slug || 'N/A'}, Roles: {item.roles || 'N/A'})</span>
                                    ) : (
                                        <pre className="text-xs whitespace-pre-wrap">{JSON.stringify(item, null, 2)}</pre>
                                    )}
                                </li>
                            ))}
                        </ul>
                    );
                }
                if (typeof categoryData === 'object' && categoryData !== null) {
                     if (categoryData.status && Object.keys(categoryData).length === 1) { // For unsupported features like widgets/menus
                         return <p className="text-gray-500 italic">{categoryData.status}</p>;
                     }
                    return (
                        <table className="w-full text-sm table-fixed">
                            <tbody>
                                {Object.entries(categoryData).map(([key, value]) => (
                                    <tr key={key} className="border-b hover:bg-gray-50">
                                        <th className="p-2 text-left align-top bg-gray-100 w-1/3 md:w-1/4 break-words">{key}</th>
                                        <td className="p-2 align-top break-words">{String(value !== null && value !== undefined ? value : 'N/A')}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    );
                }
                return <p>{String(categoryData)}</p>;
            };

            const HelpModal = ({ onClose }) => {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-2xl font-bold text-gray-800">使い方ガイド</h2>
                                <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                            </div>
                            
                            <div className="space-y-6 text-gray-700">
                                <section>
                                    <h3 class="text-xl font-semibold mb-2 text-blue-600">ツールの利用手順</h3>
                                    <ol class="list-decimal list-inside space-y-1 pl-4">
                                        <li><strong>ダウンロード:</strong> このリポジトリから <code>index.html</code> ファイルを取得します。</li>
                                        <li><strong>開く:</strong> <code>index.html</code> ファイルを直接ウェブブラウザ（例: Chrome, Firefox, Edge）で開きます。</li>
                                        <li><strong>認証情報を入力:</strong>
                                            <ul class="list-disc list-inside space-y-1 pl-6 mt-1">
                                                <li>WordPressサイトの完全なURL（例: <code>https://example.com</code>）を入力します。</li>
                                                <li>WordPressのユーザー名またはアプリケーションパスワードのユーザー名を入力します。</li>
                                                <li>WordPressのパスワードまたはアプリケーションパスワードを入力します。（セキュリティ上の理由やプラグインによる制限により、通常のパスワードでは認証できない場合があります。その際は、<strong>アプリケーションパスワードの使用を強く推奨します。</strong> 設定方法は下記を参照してください。）</li>
                                            </ul>
                                        </li>
                                        <li><strong>データ抽出:</strong> 「ログインして抽出開始」ボタンをクリックします。ツールがWordPressサイトからデータを取得します。</li>
                                        <li><strong>レポートをダウンロード:</strong> 抽出が完了すると、概要が表示されます。「HTMLをダウンロード」ボタンをクリックしてレポートを保存します。</li>
                                    </ol>
                                </section>

                                <section>
                                    <h3 class="text-xl font-semibold mb-2 text-orange-600">アプリケーションパスワードの推奨と設定方法</h3>
                                    <p className="mb-2">セキュリティプラグインやホスティング環境の設定により、通常のユーザー名とパスワードによるREST API認証（基本認証）が無効化されている場合があります。その場合、WordPressの「アプリケーションパスワード」機能を利用することで、より安全かつ確実に認証を行うことができます。</p>
                                    <h4 class="text-lg font-semibold mt-3 mb-1">設定手順:</h4>
                                    <ol class="list-decimal list-inside space-y-1 pl-4">
                                        <li><strong>WordPressダッシュボードにログイン:</strong> 対象のWordPressサイトの管理画面にログインします。</li>
                                        <li><strong>ユーザープロファイル編集画面へ移動:</strong> 左側メニューの「ユーザー」から、ご自身のユーザー名（またはAPI連携用の専用ユーザー）にマウスオーバーし、「編集」をクリックします。</li>
                                        <li><strong>アプリケーションパスワードセクションへスクロール:</strong> プロファイル編集画面を下にスクロールしていくと、「アプリケーションパスワード」というセクションがあります。</li>
                                        <li><strong>新しいアプリケーションパスワード名を入力:</strong> 「新しいアプリケーションパスワード名」の欄に、このツールで使用することがわかるような名前（例: <code>WordPress Reporter</code>）を入力します。</li>
                                        <li><strong>「新しいアプリケーションパスワードを追加」をクリック:</strong> ボタンをクリックすると、下にパスワードが生成されます。
                                            <ul class="list-disc list-inside space-y-1 pl-6 mt-1">
                                                <li class="text-red-600 font-semibold"><strong>重要:</strong> このパスワードは<strong>一度しか表示されません。</strong> 必ずコピーして安全な場所に保管してください。画面を閉じると二度と確認できません。</li>
                                            </ul>
                                        </li>
                                        <li><strong>ツールで使用:</strong> 本ツールの「ユーザー名」欄にはWordPressのユーザー名を、「パスワード」欄にはここで生成・コピーしたアプリケーションパスワード（スペースを含めずに）を入力してください。</li>
                                    </ol>
                                    <p className="mt-3">アプリケーションパスワードを利用することで、メインのパスワードを直接使用することなく、本ツールにWordPressサイトへのアクセス権を安全に付与できます。</p>
                                </section>
                            </div>
                            <div className="mt-6 text-right">
                                <button onClick={onClose} className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                    閉じる
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div id="root" className="container mx-auto p-4 min-h-screen flex flex-col">
                    <div className="text-right text-xs text-gray-500 mb-2">バージョン 1.1.0</div>
                    {currentView === 'login' && (
                        <div className="bg-white shadow-md rounded-lg p-8 max-w-lg mx-auto">
                            <h1 className="text-3xl font-bold text-center text-blue-700 mb-4">WordPress 設定情報抽出ツール</h1>
                            <div className="flex justify-center mb-6 space-x-2">
                                <a href="https://github.com/rinmon/WordPress-Reporter/releases/latest" target="_blank" rel="noopener noreferrer" className="inline-flex items-center">
                                    <img src="https://img.shields.io/github/v/release/rinmon/WordPress-Reporter?label=v1.1.0" alt="GitHub release" className="h-5" />
                                </a>
                                <a href="https://github.com/rinmon/WordPress-Reporter" target="_blank" rel="noopener noreferrer" className="inline-flex items-center">
                                    <img src="https://img.shields.io/badge/GitHub-Repository-181717?logo=github" alt="GitHub repo" className="h-5" />
                                </a>
                            </div>
                            {error && (
                                <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
                                    <strong className="font-bold">エラー: </strong>
                                    <span className="block sm:inline">{error}</span>
                                </div>
                            )}
                            <form onSubmit={handleLogin}>
                                <div className="mb-6">
                                    <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="wpUrl">WordPress サイト URL</label>
                                    <input className="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="wpUrl" type="url" placeholder="例: https://example.com" value={wpUrl} onChange={(e) => setWpUrl(e.target.value)} required />
                                </div>
                                <div className="mb-6">
                                    <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="username">ユーザー ID またはメールアドレス</label>
                                    <input className="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="username" type="text" placeholder="WordPress のユーザー名" value={username} onChange={(e) => setUsername(e.target.value)} required />
                                </div>
                                <div className="mb-8">
                                    <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">パスワード (またはアプリケーションパスワード)</label>
                                    <input className="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="password" type="password" placeholder="••••••••••••" value={password} onChange={(e) => setPassword(e.target.value)} required />
                                </div>
                                <div className="flex items-center justify-center">
                                    <button className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline w-full text-lg transition duration-150 ease-in-out transform hover:scale-105 mb-4" type="submit" disabled={isLoading}>
                                        {isLoading ? '処理中...' : 'ログインして抽出開始'}
                                    </button>
                                </div>
                            </form>
                            <button onClick={() => setShowHelpModal(true)} className="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mt-2">
                                使い方を見る
                            </button>
                        </div>
                    )}
                    {currentView === 'loading' && (
                        <div className="bg-white shadow-md rounded-lg p-8">
                            <h1 className="text-2xl font-bold text-center text-blue-600 mb-6">WordPress 設定情報抽出ツール</h1>
                            <p className="text-center text-gray-700 mb-4">設定情報を抽出中です...</p>
                            <div className="w-full bg-gray-200 rounded-full h-6 mb-4">
                                <div className="bg-blue-500 h-6 rounded-full text-xs font-medium text-blue-100 text-center p-1 leading-none" style={{ width: `${progress}%` }}>
                                    {progress}%
                                </div>
                            </div>
                            <p className="text-center text-gray-600 text-sm mb-6">この処理には数分かかる場合があります。</p>
                            <div className="text-center">
                                <button onClick={handleCancel} className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                    キャンセル
                                </button>
                            </div>
                        </div>
                    )}
                    {currentView === 'results' && (() => {
                        if (!extractedData || !extractedData.details) {
                            return (
                                <div className="bg-white shadow-md rounded-lg p-8 max-w-lg mx-auto text-center">
                                    <p className="text-red-500 font-semibold">表示するデータがありません。</p>
                                    <button
                                        onClick={() => { setCurrentView('login'); setExtractedData(null); }}
                                        className="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                                    >
                                        ログイン画面に戻る
                                    </button>
                                </div>
                            );
                        }

                        const { siteTitle, generationDate, details, summary } = extractedData;
                        // categoryTitles and renderDetailSection are now in App's scope

                        return (
                            <div className="bg-white shadow-xl rounded-lg p-4 sm:p-6 md:p-8 max-w-5xl w-full mx-auto my-8">
                                <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 pb-4 border-b">
                                    <div className="mb-4 md:mb-0">
                                        <h1 className="text-xl sm:text-2xl md:text-3xl font-bold text-blue-700">{siteTitle || 'WordPress 設定レポート'}</h1>
                                        <p className="text-xs sm:text-sm text-gray-500 mt-1">生成日時: {generationDate}</p>
                                    </div>
                                    <div className="flex space-x-2 sm:space-x-3">
                                        <button
                                            onClick={() => { setCurrentView('login'); setExtractedData(null); }}
                                            className="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-3 sm:px-4 text-xs sm:text-sm rounded focus:outline-none focus:shadow-outline transition duration-150"
                                        >
                                            戻る
                                        </button>
                                        <button
                                            onClick={handleGenerateHtml}
                                            disabled={isLoading}
                                            className={`bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 sm:px-4 text-xs sm:text-sm rounded focus:outline-none focus:shadow-outline transition duration-150 ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}`}
                                        >
                                            {isLoading ? '生成中...' : 'HTMLをダウンロード'}
                                        </button>
                                    </div>
                                </div>

                                {summary && (
                                     <div className="mb-6 p-3 sm:p-4 bg-indigo-50 rounded-lg shadow">
                                        <h2 className="text-lg sm:text-xl font-semibold text-indigo-700 mb-3">抽出結果サマリー</h2>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 sm:gap-4 text-xs sm:text-sm">
                                            <div><strong>総カテゴリ数:</strong> {summary.categories}</div>
                                            <div><strong>総アイテム数:</strong> {summary.totalItems}</div>
                                            {summary.itemsPerCategory && Object.entries(summary.itemsPerCategory).map(([key, value]) => (
                                                <div key={key} className="truncate"><strong>{categoryTitles[key] || key.charAt(0).toUpperCase() + key.slice(1)}:</strong> {value}</div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                <div className="space-y-6">
                                    {details && Object.entries(details).map(([categoryKey, categoryValue]) => (
                                        <section key={categoryKey} className="p-3 sm:p-4 border rounded-md shadow-sm bg-white">
                                            <h2 className="text-lg sm:text-xl font-semibold text-gray-800 mb-3 capitalize border-b pb-2">
                                                {categoryTitles[categoryKey] || categoryKey.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}
                                            </h2>
                                            {renderDetailSection(categoryKey, categoryValue)}
                                        </section>
                                    ))}
                                </div>
                            </div>
                        );
                    })()}
                    {showHelpModal && <HelpModal onClose={() => setShowHelpModal(false)} />}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
